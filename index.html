<!DOCTYPE html>
<html lang="en" ng-app="bbcgApp">
    <head>
        <meta charset="UTF-8" />
        <title>BBCG</title>
		
		<style>
			.base.hasRunner { border:1px solid #000; }
			.stealButton { display:none; }
			.stealButton.visible { display:block; }

			#scoreboard ul li {
				list-style-type:none;
				display:inline;
				margin-right:10px;
			}
		</style>
    </head>
    <body ng-controller="GameCtrl">
		<noscript>
			<p>You need javascript to access this site</p>
		</noscript>
		
		<section id="container">
			<section id="field">
				<section id="dirt" class="sand"></section>
				<section id="diamond">
					<section id="first" ng-class="{ hasRunner : game.bases[0] == 1}" class="base">1</section>
					<section id="second" ng-class="{ hasRunner : game.bases[1] == 1}" class="base">2</section>
					<section id="third" ng-class="{ hasRunner : game.bases[2] == 1}" class="base">3</section>
					<section id="homePlate" class="base hasRunner">4</section>
					<section id="mound" class="sand"><section id="rubber"></section></section>
					<!--section id="pitcherCard" class="card back"></section-->

					<span ng-switch on="myRole">
						<section ng-switch-when="batter">
							<button type="button" id="stealSecond" ng-class="{ visible : game.bases[0] == 1 && game.bases[1] == 0 }" class="button stealButton" ng-click="stealBase(2)">Steal 2nd</button>
							<button type="button" id="stealThird" ng-class="{ visible : game.bases[1] == 1 && game.bases[2] == 0 }" class="button stealButton" ng-click="stealBase(3)">Steal 3rd</button>
							<button type="button" id="stealSecondAndThird" ng-class="{ visible : game.bases[0] == 1 && game.bases[1] == 1 && game.bases[2] == 0 }" class="button stealButton" ng-click="stealBase(5)">Double Steal (2nd &amp; 3rd)</button>
							<button type="button" id="stealHome" ng-class="{ visible : game.bases[2] == 1 }" class="button stealButton" ng-click="stealBase(4)">Steal Home</button>
						</section>
					</span>
				</section>
			</section>
		</section>
		
		<section id="scoreboard">
			<!--ul id="headers" class="clearfix">
				<li>1</li>
				<li>2</li>
				<li>3</li>
				<li>4</li>
				<li>5</li>
				<li>6</li>
				<li>7</li>
				<li>8</li>
				<li>9</li>
				<li>R</li>
			</ul-->
			
			<p id="awayTeamLabel" class="left highlight">Visitor</p>
			<ul id="visitor" class="clearfix">
				<li ng-repeat="score in game.scores.away">{{score}}</li>
				<li>{{game.scores.away.sum()}}</li>
			</ul>
			
			<p id="homeTeamLabel" class="left">Home</p>
			<ul id="home" class="clearfix">
				<li ng-repeat="score in game.scores.home">{{score}}</li>
				<li>{{game.scores.home.sum()}}</li>
			</ul>

			<p>Outs: {{game.outs}}</p>
			<!--section class="right">
				<p>Out</p>
				<ul id="outs" class="clearfix">
					<li>O</li>
					<li>O</li>
				</ul>
			</section-->

			<p>Inning: {{game.currentInning}}</p>
			<p>Batting: {{game.teamOnOffense}}</p>
			<!--section class="left clearfix">
				<p class="left">Inn</p>
				<ul class="left">
					<li id="inning">0</li>
					<li id="teamOnOffense" class="away"></li>
				</ul>
			</section-->
		</section>

		<h3>Last play:</h3>
		<p>Pitcher selected: {{game.pitcherCard.value}}</p>
		<p>Batter selected: {{game.batterCard.value}}</p>

		<h3>This play:</h3>
		<span ng-switch on="myRole">
			<section ng-switch-when="batter" ng-include="'partials/batter.html'"></section>
			<section ng-switch-when="pitcher" ng-include="'partials/pitcher.html'"></section>
		</span>
		
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.min.js"></script>
		<script>
			Array.prototype.sum = function() {
				return this.reduce(function(a,b){return a+b;});
			};
		</script>
		
		<script src="/socket.io/socket.io.js"></script>
		<script>
			var app = angular.module('bbcgApp', []);
			
			var socket = io.connect('http://localhost:1337');
			socket.on('consoleMessage', function(msg){
				console.log(msg);
			});

			app.factory('socket', function ($rootScope) {
				var socket = io.connect();
				return {
					on: function (eventName, callback) {
						socket.on(eventName, function () {
							var args = arguments;
							$rootScope.$apply(function () {
								callback.apply(socket, args);
							});
						});
					},
					emit: function (eventName, data, callback) {
						socket.emit(eventName, data, function () {
							var args = arguments;
							$rootScope.$apply(function () {
								if (callback) {
									callback.apply(socket, args);
								}
							});
						})
					}
				};
			});
		</script>
		<script>
			/*
			 * TODO
			 *
			 * ON single - says 0 runs scored
			 * Add a refresh check to make sure people do not accidentally refresh the browser
			 * Make the disconnect end the game for both players - the team that didn't disconnect will "win"
			 * Slow the game down a bit - decisions seem to be too fast
			 * Change it so that there can be multiple games going - if both players disconnect, remove the game from the server
			 * 
			 * Allow the user to name their team for the game (and colour of deck/playing pieces)
			 * Add a span to represent the runner on base - animate them when they score
			 * Add a span to represent the ball and animate it to where it goes on the play
			 * Add the ability for users to roll their own dice
			 * Store the team in a database in the backend - show standings based on player locality (UK, USA, Kent UK leagues etc)
			 *
			 */
			function GameCtrl($scope, socket) {
				socket.on('displayMessage', function(message) {
					console.log(message.text);
					/*$('#messageBox').append('<p class="'+type+'">'+message+'</p>').animate({
					scrollTop:$("#messageBox")[0].scrollHeight
					}, 1000);*/
				});
				
				socket.on('updateGameModel', function(game) {
					$scope.game = game;
				});
				
				socket.on('updateRole', function(role) {
					$scope.myRole = role;
				});
				
				/*----- User interaction events -----*/
				
				$scope.selectPitcherCard = function(index) {
					if (!$scope.game.gameover && !$scope.game.pitcherReady) { //prevent double clicking
						socket.emit('throwPitch', { index: index });
					}
				}
				
				$scope.selectBatterCard = function(index) {
					if (!$scope.game.gameover && $scope.game.pitcherReady) {
						socket.emit('swingBat', { index: index });
					}
				};
				
				$scope.stealBase = function(base) {
					socket.emit('stealBase', { base: base });
				}
			}
		</script>
    </body>
</html>